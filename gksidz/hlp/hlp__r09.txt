^015
~175 Описание работы регулятора: ~004ДОЗИРОВКА ПАСТЫ ~175[9]
~005 ================================================


~047 НАЧАЛО:

~003 -------------------------------------------------------------------------------

~047 ШАГ 00:
~001         ПРОВЕРКА начального СОСТОЯНИЯ РЕГУЛЯТОРА

~006         0>>~000Если регулятор выключен (REG07R___V==OFF) - выйти.
~006         1>>~000Если верхняя мешалка пасты на руке- выйти.
~007            ~007if(DIR280___V==MANUAL){ return; }
~006         2>>~000Если включен контроль уровня и есть сигнал аварийного уровня- выйти
~007            ~007if(CTRL_LLPEV==ON and DIA285___V==ON){ return; }
~006         3>>~000если включен контроль уровня и есть сигнал верхнего уровня
~000            ~000в миксере ал.пасты- выйти
~007            ~007if(CTRL_HLPEV==ON and DIH285___V==ON){ return; }
~006         4>>~000если открыт клапан загрузки в дозатор- выйти
~007            ~007if(DIS286___V==ON){ return; }
~006         5>>~000если открыт клапан выгрузки из дозатора- выйти
~007            ~007if(DIS291___V==ON){ return; }
~006         6>>~000если включена мешалка миксера- выйти
~007            ~007if(DIS285___V==ON){ return; }
~006         7>>~000если выключен привод мешалки сусп ал пасты верхней- выйти
~007            ~007if(DIS280___V==OFF){ return; }
~006         8>>~000если включен контроль уровня и есть сигнал нижнего уровня
~000            ~000верхней мешалки ал.пасты- выйти
~007            ~007if(CTRL_LLM2V==ON and DIL280___V==ON){ return; }
~006         9>>~000проверка флага работоспособности прибора дозатора пасты
~007            ~007if(COM2ER03FL==ON){ return; }

~000         ~000запомнить вес дозатора пасты
~007         ~007AIW290___O=AIW290___V;
~007         ~007AIW290NV_V=AIW290___V;
~000         ~000обнулить счетчик проверки веса стабилизации набора пасты
~007         ~007TIME_PAVSC=0;

~000         ~000если регулятор в локальном режиме и выбран режим загрузки-
~000         ~000перейти на шаг набора ал.пасты в миксер
~007         ~007if(REG09GL__V==OFF and REG09ZV__V==ON){ DON803___V=0; ШАГ=01; }

~000         ~000если регулятор в локальном режиме и выбран режим выгрузки-
~000         ~000перейти на шаг выгрузки
~007         ~007if(REG09GL__V==OFF and REG09ZV__V==OFF) ШАГ=10;

~000         ~000если регулятор в общем режиме и включен общий регулятор и
~000         ~000дозатор сухого и мокрого уже выгружены- перейти на шаг загрузки
~007         ~007if(REG09GL__V==ON and RegPublicV==ON and
~007         ~007   DON801___V==2  and DON802___V==2  and DON803___V==0)
~007         ~007   ШАГ=01;

~003 -------------------------------------------------------------------------------

~047 ШАГ 01:
~001         НАБОР АЛ.ПАСТЫ в МИКСЕР

~000         Если это первый цикл на этом шаге- обнулить все таймеры регулятора
~000         и закрыть все исполнители регулятора
~007         Clear_TO (91); Clear_TO(92); TIME_PNMXC=0; Regul_09off();
~006         1>>
~000         Открыть клапан загрузки миксера ал.пасты
~007         кл загр микс     привод микс      кл загр дозат    кл выгр дозат
~007         DON281___V=ON;;  DON285___V=OFF;  DON286___V=OFF;  DON291___V=OFF;
~000         проверка сработки сигнала аварийного уровня миксера ал.пасты:
~007         switch ( Check_TO(91, 5*SEC, DIA285___V,'=',ON, 2 ))
~008             если сработал аварийный уровень
~007             case END:{ 
~008                   // если включен контроль аварийного уровня- 
~008                   // сигнал, сообщение, выключить регулятор
~007                   if(CTRL_LLPEV==ON){
~007                      Bell(1); Message(406); Message(679); Clear_TO(91);
~007                      REG09R___M=OFF; Regul_09off(); return;
~007                   }
~000         счетчик ожидания включения сигнала верх уровня миксера ал.пасты:
~007         switch ( Check_TO(92, TIME_PNMXW*SEC, DIH285___V,'=',ON, 2 ))
~007             case RUN:{ TIME_PNMXC++; return; }
~008             если за заданное время сигнал верх уровня миксера не сработал
~007             case BAD:{ Message(407); Clear_TO(92); break;; }
~000             если сработал сигнал верх уровня миксера
~007             case END:{ 
~000                        // если отключен контроль уровня- сообщение
~007                        if(CTRL_HLPEV==OFF){
~007                           TIME_PNMXC++;
~007                           if(TIME_PNMXC>TIME_PNMXW){ 
~007                              Message(407); Clear_TO(92); break; }
~000         Обнулить таймеры и закрыть все исполнители
~007         Clear_TO (91); Clear_TO(92); Regul_09off();
~000         перейти на следующий шаг
~007         ~001ШАГ~007=~004 02;

~003 -------------------------------------------------------------------------------

~047 ШАГ 02:
~001         ПЕРЕМЕШИВАНИЕ АЛ.ПАСТЫ в МИКСЕРЕ

~000         Если это первый цикл на этом шаге- обнулить все таймеры регулятора
~000         и закрыть все исполнители регулятора
~007         Clear_TO(91); Clear_TO (92); TIME_PPMXC=0; Regul_09off();
~006         1>>
~000         Включить миксер ал.пасты
~007         кл загр микс     привод микс      кл загр дозат    кл выгр дозат
~007         DON281___V=OFF;  DON285___V=ON;;  DON286___V=OFF;  DON291___V=OFF;
~000         Проверка включения привода миксера (передергивание)
~007         switch ( Check_TO  (92, TIME_ISPKV*SEC, DIS285___V,'=',ON,  1 )){
~007             case BAD: {
~007                         if(DONCN09>1){ DONCN09=0; break;; }
~007                         Isp09PD(&DON285___V,3,TIME_ISPPW,70,STEP09P,92); return;
~000         счетчик времени перемешивания ал.пасты в миксере ал.пасты:
~007         switch ( Check_TO(91, TIME_PPMXW*SEC, ZERO,'=',ON, 2 )){
~007             case RUN:{ TIME_PPMXC++; return; }
~000         обнулить счетчики и закрыть все исполнители регулятора
~007         Clear_TO(91); Clear_TO(92); DONCN09=0; Regul_09off();
~000         перейти на следующий шаг
~007         ~001ШАГ~007=~004 03;

~003 -------------------------------------------------------------------------------

~047 ШАГ 03:
~001         ПРОВЕРКА ЗАКРЫТИЯ КЛАПАНА ДОЗАТОРА

~000         Если это первый цикл на этом шаге- обнулить таймер
~007         Clear_TO(91);
~006         1>>
~000         ~000Счетчик проверки
~007         switch ( Check_TO  (91, TIME_ISPKV*SEC, DIS291___V,'=',OFF,  1 ))
~008             если не закрылся- звонок, сообщение, выкл. регулятор
~007             case BAD: { Bell(1); Message(408); Message(679); Clear_TO(91);
~007                         REG09R___M=OFF; Regul_09off(); return; }
~000         обнулить счетчик
~007         Clear_TO(91);
~000         перейти на следующий шаг
~007         ~001ШАГ~007=~004 03;

~003 -------------------------------------------------------------------------------

~047 ШАГ 04:
~001         ЗАГРУЗКА АЛ.ПАСТЫ В ДОЗАТОР

~000         Если это первый цикл на этом шаге- обнулить все таймеры регулятора
~000         и закрыть все исполнители регулятора, открыть клапан загрузки дозатора
~007         Clear_TO(91); TIME_PAVSC=0; LOAD_PAVSC=0; TIME_PIMNC=0; TIME_PIMPC=0;
~007         AIW290___O=AIW290___V; Regul_09off();
~008         кл загр микс     привод микс      кл загр дозат    кл выгр дозат
~007         DON281___V=OFF;  DON285___V=OFF;  DON286___V=ON;;  DON291___V=OFF;
~006         1>>
~000         определить вес отсечки, задания и блокировки
~007         AIW290VO_V = TRPAS__VIB-LOAD_PAVOW;
~007         AIW290VZ_V = TRPAS__VIB;
~007         AIW290VB_V = TRPAS__VIB+BLPAS____V;
~000         если набран заданный вес - перейти на след шаг
~007         if(AIW290___V > AIW290VO_V){ DON286___V=OFF; ~001ШАГ~007=~004 05; ~007return; }
~000         раз в секунду переменная RegRUN=ON (выполняется код располож ниже)
~007         if(RegRUN==OFF){ return; }
~000         вес набранной пасты
~007         CRPAS____V=AIW290___V-AIW290NV_V; AIW290FV_V=1;
        
~001         ПРОВЕРКА ИЗМЕНЕНИЯ ВЕСА НАБОРА в дозатор ал.пасты:
~000         если открыт клапан набора-увеличить счетчик текущего времени
~007         if(DIS286___V==ON){ TIME_PAVSC++; }
~000            если счетчик больше заданного
~007            if(TIME_PAVSC>TIME_PAVSW){
~000               если запомненный вес дозатора + заданный вес стабилизации больше
~000               чем текущий вес дозатора (нет набора веса)
~007               if(AIW290___O+LOAD_PAVSW>AIW290___V){
~000                  увеличить счетчик проверок веса стабилизации
~007                  LOAD_PAVSC++;
~000                  если счетчик проверок веса стабилизации >2 
~008                  (2-е проверки подряд нет набора веса)-
~008                  закрыть клапан набора и перейти на след шаг
~007                  if(LOAD_PAVSC>CNST_PAN_W){ DON286___V=OFF; ~001ШАГ~007=~004 05; ~007return; }
~000               если вес набирается нормально- обнулить счетчик проверок веса
~007               LOAD_PAVSC=0;
~000            запомнить текущий вес дозатора
~007            AIW290___O=AIW290___V;
~000            обнулить счетчик текущего времени стабилизации
~007            TIME_PAVSC=0;

~001         ПЕРЕДЕРГИВАНИЕ КЛАПАНА
~000         если текущий вес дозатора меньше веса перехода на импульсный режим
~000         набора- проверить клапан на открытие(при необходимости- передернуть)
~007         if(AIW290___V<MODE_PIMZW){
~007            DON286___V = ON;
~007            switch ( Check_TO  (91, TIME_ISPKV*SEC, DIS286___V,'=',ON, 1 )){
~008                       если после передергивания клапан не открылся-
~008                       сообщение, звонок, выключить регулятор
~007                       if(DONCN09>2){ Bell(1); Message(299); Message(679); 
~007                                      REG09R___M=OFF; break; 

~001         ИМПУЛЬСНЫЙ НАБОР
~000         если набрали вес для перехода на импульсный режим набора
~007         } else {
~000         если счетчик набора меньше заданного- выдать комманду на открытие 
~000         клапана и увеличить счетчик
~007         if(TIME_PIMNC<TIME_PIMNW){ DON286___V=ON;; TIME_PIMNC++; }
~007         else {
~000              выдать комманду на закрытие клапана
~007              DON286___V=OFF;
~000              если счетчик набора больше или равен заданному и счетчик
~000              паузы меньше заданного- увеличить счетчик паузы
~007              if(TIME_PIMPC<TIME_PIMPW){ DON286___V=OFF; TIME_PIMPC++; }
~000              если счетчик паузы больше или равен заданному-
~000              обнулить счетчик набора и счетчик паузы
~007              else                     { TIME_PIMNC=0;   TIME_PIMPC=0; }
~000         выйти


~003 -------------------------------------------------------------------------------

~047 ШАГ 05:
~001         ПРОВЕРКА СТАБИЛИЗАЦИИ ВЕСА ДОЗАТОРА АЛ.ПАСТЫ ПОСЛЕ ЗАГРУЗКИ

~000         Если это первый цикл на этом шаге- обнулить таймеры регулятора
~000         и запомнить текущий вес дозатора
~007         Clear_TO(91); Clear_TO(92); CNST_PAN_C=0; AIW290___O=AIW290___V;
~006         1>>
~000         Закрыть все исполнители регулятора и запомнить набранный вес ал.пасты
~007         Regul_09off(); CRPAS____V=AIW290___V-AIW290NV_V; AIW290FV_V=1;

~000         проверить закрытие клапана набора алюминевой пасты в дозатор
~007         switch ( Check_TO (91, TIME_ISPKV*SEC, DIS286___V,'=',OFF, 1 ))
~007             case BAD: { 
~008                         если после передергивания клапан не закрылся-
~008                         сообщение, звонок, выключить регулятор
~007                         if(DONCN09>2){ 
~007                            Bell(1); Message(297); Message(679);
~007                            REG09R___M=OFF; return;; 
~007             case END: { DONCN09=0; AIW290___O=AIW290___V; break;; }

~006         2>>
~000         ждать время стабилизации веса
~007         switch ( Check_TO  (92, TIME_PAVSW*SEC, ZERO,'=',ON, 1)){
~000         Обнулить счетчики
~007         Clear_TO(91); Clear_TO(92);

~000         если запомненный вес дозатора + вес стабилизации меньше текущего
~000         веса дозатора (вес продолжает набираться(нет стабилизации веса))
~007         if(AIW290___O+LOAD_PAVSW<AIW290___V)
~007            CNST_PAN_C++;
~008            если счетчик проверок стабилизации больше заданного-
~008            сообщение, звонок, выключить регулятор
~007            if(CNST_PAN_C>CNST_PAN_W){
~007               Bell(1); Message(296); Message(679); REG09R___M=OFF; return;
~008            если счетчик проверок меньше заданного запомнить текущий вес
~008            и еще раз проверить (выполнить этот же шаг)
~007               DON286___V=ON;  AIW290___O=AIW290___V; return;

~000         если текущий вес дозатора + вес допуска < веса задания
~000         (не набрали нужный вес)- звонок,сообщение,выкл регулятор
~007         if(AIW290___V+DPPAS____V<TRPAS__VIB){
~007            Bell(1); Message(391); Message(679); REG09R___M=OFF; return;
~000         если текущий вес дозатора > веса задания + вес допуска
~000         (перебрали нужный вес)- звонок,сообщение,выкл регулятор
~007         if(AIW290___V>TRPAS__VIB+DPPAS____V){
~007            Bell(1); Message(392); Message(679); REG09R___M=OFF; return;

~000         флаг набора веса дозатора пасты
~007         DON803___V=1;

~000         если регулятор в общем режиме- перейти на шаг выгрузки
~007         if(REG09GL__V==ON and RegPublicV==ON){ ~001ШАГ~007=~004 10; ~007return; }

~000         если регулятор в локальном режиме- выключить регулятор
~007         Message(390); REG09R___M=OFF; return;
        
~003 -------------------------------------------------------------------------------


~003 -------------------------------------------------------------------------------

~001         ВЫГРУЗКА ИЗ ДОЗАТОРА АЛЮМИНЕВОЙ ПАСТЫ В ВГБМ:

~047 ШАГ 10:
~001         ПРОВЕРКА УСЛОВИЙ выгрузки (готовности ВГБМ)

~000         Если это первый цикл на этом шаге- обнулить таймеры регулятора
~007         Clear_TO(91); Clear_TO(92); Clear_TO(93);
~006         1>>
~000         Закрыть все исполнители регулятора и выключить флаг руковов ВГБМ
~007         Regul_09off(); RUKAVA=OFF;
~006         1>>~000если ВГБМ нет на месте - выйти
~007            switch ( Check_TO  (91, 1*MIN, DIS315___V,'=',ON,  1 )){
~007                case BAD: { Bell(1); Message(385); Clear_TO(91); return;; }
~006         2>>~000если ВГБМ не включена - выйти
~007            switch ( Check_TO  (92, 1*MIN, DIS310___V,'=',ON,  1 )){
~007                case BAD: { Bell(1); Message(386); Clear_TO(92); return;; }
~006         3>>~000если герметизатор не опущен - выйти
~007            switch ( Check_TO  (93, 1*MIN, DIS31A___V,'=',ON,  1 )){
~007                case BAD: { Clear_TO(93); Message(387); Bell(1); return;; }
~006         4>>~000рукава не закрыты - выйти
~007            if(DIS316___V==ON or DIS317___V==ON){ RUKAVA=ON; }
~007            switch ( Check_TO  (94, 1*MIN, RUKAVA,'=',OFF,  1 )){
~007            case BAD: { Clear_TO(94); Message(295); Bell(1); return;; }

~000         обнулить таймеры, запомнить вес дозатора пасты
~007         Clear_TO(91); Clear_TO(92); Clear_TO(93); AIW290___S=AIW290___V;
~000         обнулить флаг стабилизации веса выгрузки 
~007         PA_VSTB=  0;                 
~000         перейти на следующий шаг
~007         ~001ШАГ~007=~004 11;

~003 -------------------------------------------------------------------------------

~047 ШАГ 11:
~001         ОТКРЫТИЕ КЛАПАНА выгрузки в ВГБМ

~000         Если это первый цикл на этом шаге- закрыть исполнители, 
~000         запомнить текущий вес
~007         Regul_09off(); AIW290___O=AIW290___V;
~006         1>>
~000         открыть клапан выгрузки в ВГБМ
~007         DON291___V = ON;
~007         switch ( Check_TO  (91, TIME_ISPKV*SEC, DIS291___V,'=',ON, 1 )){
~008             если клапан не открылся- передернуть его
~007             case BAD: { 
~007                         Bell(1); Message(161); Message(679); 
~007                         REG09R___M=OFF; return;; 
~000         перейти на следующий шаг
~007         ~001ШАГ~007=~004 12;

~003 -------------------------------------------------------------------------------

~047 ШАГ 12:
~001         ПРОВЕРКА ВЕСА ДОЗАТОРА

~000         Если это первый цикл на этом шаге- обнулить счетчики
~000         вес стабил    врем стабил   счетч стаб    дл имп выг    дл имп паузы
~007         VSST_PAVIC=0; TMST_PAVIC=0; CNST_PAVIC=0; TIME_PIVVC=0; TIME_PIVPC=0;
~006         1>>
~000         если установлен режим "Выгрузить все"
~007         if(MODE_PVIGW>0){
~000            если текущий вес дозатора меньше или равен нулю или 
~000            счетчик стабилизации больше заданного- перейти на след шаг
~007            if(AIW290___V<=0 or CNST_PAVIC>=CNST_PAVIW){ 
~007               ~001ШАГ~007=~004 14;~007 return; 
~000         если установлен режим "Выгрузить рецепт"
~000         если текущий вес дозатора меньше, чем запомненный вес дозатора
~000         перед выгрузкой - вес рецепта + вес отсечки:
~000         закрыть все исполнители и перейти на следующий шаг
~007         if(AIW290___V<AIW290___S-TRPAS__VIB+VIGR_PVOTW){
~007            Regul_09off(); ~001ШАГ~007=~004 14;~007 return; 

~000         если подошло время проверки стабилизации веса дозатора
~007         TMST_PAVIC++;
~007         if(TMST_PAVIC>TMST_PAVIW){
~000            если тек вес дозатора + вес стабилизации больше запомненного
~000            веса- значит вес стабилизировался ("не изменяется"(в пределах))
~000            увеличить счетчик стабилизац веса
~007            if(AIW290___V+VSST_PAVIW>AIW290___O){ CNST_PAVIC++; }
~007            else                                 { CNST_PAVIC=0; }
~000         запомнить текущий вес дозатора и обнулить счетчик времени
~007         AIW290___O=AIW290___V; TMST_PAVIC=0;

~001         ИМПУЛЬСНЫЙ РЕЖИМ ВЫГРУЗКИ
~000         если выгрузили вес до веса перехода на импульсный режим выгрузки
~007         if(AIW290___V<MODE_PIMVW){
~000            если счетчик выгрузки меньше заданного- выдать комманду на
~000            открытие клапана и увеличить счетчик
~007            if(TIME_PIVVC<TIME_PIVVW){ 
~007               DON291___V=ON;; TIME_PIVVC++; 
~000            если счетчик выгрузки больше заданного заданного- 
~000            выдать комманду на закрытие клапана
~007            DON291___V=OFF;
~008            если счетчик набора больше или равен заданному и счетчик
~008            паузы меньше заданного- увеличить счетчик паузы
~007           if(TIME_PIVPC<TIME_PIVPW){ DON291___V=OFF; TIME_PIVPC++; }
~008           если счетчик паузы больше или равен заданному-
~008           обнулить счетчик набора и счетчик паузы
~007           else                     { TIME_PIVVC=0;   TIME_PIVPC=0; }
~000         выйти

~003 -------------------------------------------------------------------------------

~047 ШАГ 14:
~001         ПРОВЕРКА ВЕСА СТАБИЛИЗАЦИИ ПОСЛЕ ВЫГРУЗКИ
~006         1>>
~000         Закрыть все исполнители
~007         Regul_09off ();

~000         если заданный вес  дозировки ал.пасты + вес допуска меньше  (<)
~000         запомненного веса  дозатора  ал.пасты до выгрузки - текущий вес
~000         дозатора ал.пасты (выгрузили больше допустимого)
~007         if(TRPAS__VIB+DPPAS____V<AIW290___S-AIW290___V){
~000            вывести сообщение и продолжить дальше
~007            Message(393); Message(395);
~000            если надо было выгрузить рецепт, а выгрузили больше- выкл. рег
~007            if(MODE_PVIGW>0){
~007               Bell(1); Message(679); REG09R___M=OFF; return;

~000         если заданный вес  дозировки ал.пасты - вес допуска больше  (>)
~000         запомненного веса  дозатора  ал.пасты до выгрузки - текущий вес
~000         дозатора ал.пасты (выгрузили меньше допустимого)
~007         if(TRPAS__VIB-DPPAS____V>AIW290___S-AIW290___V){
~000            если флаг стабилизации меньше 2х- вернуться на откр клап выгр
~007            if(PA_VSTB<2){ PA_VSTB++; ~001ШАГ~007=~004 11;~007 return; }
~000            если после повторной выгрузки вес дозатора ал.пасты не
~000            стабилизировался- выдать сообщение и выкл. регулятор
~007            Bell(1); Message (394); Message(395); Message(679); 
~007            REG09R___M=OFF; return;
        
~000         флаг выгрузки дозатора пасты
~007         DON803___V=2;

~000         если регулятор в локальном режиме- выключить его
~007         if(REG09GL__V==OFF){ REG09R___M= OFF; }

~000         дозатор мокрого выгружается 1ым, сухого- 2ым затем паста
~000         последний выключает цикл общего регулятора
~000         если регулятор в общем режиме и выгружены дозатор сухого и мокрого-
~000         выключить общий регулятор
~007         if(RegPublicV==ON and REG09GL__V==ON and
~007            DON801___V==2  and DON802___V==2){ RegPublicM=OFF; }

~000         перейти на начальный шаг
~007         ~001ШАГ~007=~004 0;

~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~000
~003 -------------------------------------------------------------------------------
~008 *